<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:820px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    button{font-size:18px;padding:14px;border-radius:12px;border:0;cursor:pointer;width:100%}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#f2f2f2}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px}
    .muted{opacity:.75}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    code{background:#f2f2f2;padding:2px 6px;border-radius:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <h2>Elsys NFC (Harmony ID)</h2>
  <div class="muted">
    URL attendue : <code>#h=8001</code> (optionnel : <code>&p=5&a=0</code>) <span class="badge">Android + Chrome</span>
  </div>

  <div class="card">
    <b>Config attendue (ce qui doit être écrit)</b>
    <pre id="expected">(lecture...)</pre>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="writeBtn">ÉCRIRE DANS LA SONDE (NFC)</button>
      <button class="secondary" id="readBtn">LIRE LA SONDE (NFC)</button>
    </div>

    <p id="status" class="muted" style="margin:10px 0 0;"></p>
  </div>

  <div class="card">
    <b>Contenu NFC lu sur la sonde</b>
    <pre id="readOut">(rien lu pour l’instant)</pre>
    <div id="compareOut" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <b>Diagnostic</b>
    <pre id="diag" class="muted"></pre>
  </div>

<script>
/** ===== À ADAPTER ===== **/
const APP_EUI_PREFIX = "EF1C1AEF1C1A";                  // hex
const APP_KEY_PREFIX = "EF1C1AEF1C1AEF1C1AEF1C1AFFFF";  // hex

/** ===== Helpers ===== **/
const $ = (id) => document.getElementById(id);
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function isHex(s){ return /^[0-9A-F]+$/i.test(s); }
function padLeftHex(hex, len){
  hex = (hex||"").toUpperCase().replace(/[^0-9A-F]/g,"");
  return hex.padStart(len,"0");
}
function addLine(lines,k,v){
  if (v===null || v===undefined) return;
  const s = String(v).trim();
  if (!s) return;
  lines.push(`${k}:${s}`);
}
function normalizeCfg(text){
  return (text||"")
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(Boolean)
    .join("\n");
}
function cfgToMap(text){
  const m = new Map();
  for (const line of normalizeCfg(text).split("\n")) {
    const idx = line.indexOf(":");
    if (idx < 0) continue;
    const k = line.slice(0, idx).trim();
    const v = line.slice(idx+1).trim();
    if (k) m.set(k, v);
  }
  return m;
}
function getParamsFromHash(){
  const raw = decodeURIComponent((location.hash||"").replace(/^#/,"")).trim();
  return new URLSearchParams(raw);
}

/** ===== Build expected config from #h=... ===== **/
function buildCfgFromHarmony() {
  const params = getParamsFromHash();
  const hid = (params.get("h") || "").toUpperCase().replace(/[^0-9A-F]/g,"");
  if (!hid) throw new Error("ID Harmony manquant. Exemple: #h=8001");

  // LoRaWAN: AppEui = 16 hex, AppKey = 32 hex
  const needEui = 16 - APP_EUI_PREFIX.length;
  const needKey = 32 - APP_KEY_PREFIX.length;
  if (needEui <= 0) throw new Error("APP_EUI_PREFIX trop long (doit être < 16 hex).");
  if (needKey <= 0) throw new Error("APP_KEY_PREFIX trop long (doit être < 32 hex).");

  const idEui = padLeftHex(hid, needEui).slice(-needEui);
  const idKey = padLeftHex(hid, needKey).slice(-needKey);

  const appEui = (APP_EUI_PREFIX + idEui).toUpperCase();
  const appKey = (APP_KEY_PREFIX + idKey).toUpperCase();

  if (appEui.length !== 16 || !isHex(appEui)) throw new Error("AppEui généré invalide.");
  if (appKey.length !== 32 || !isHex(appKey)) throw new Error("AppKey généré invalide.");

  // Minimal join defaults
  const ota  = params.get("o") ?? "1";
  const ack  = params.get("a") ?? "0";
  const port = params.get("p") ?? "5";

  const lines = [];
  addLine(lines, "Ota", ota);
  addLine(lines, "Ack", ack);
  addLine(lines, "AppEui", appEui);
  addLine(lines, "AppKey", appKey);
  addLine(lines, "Port", port);

  // (Optionnel) si tu veux forcer des periods via l’URL courte :
  // spl=60&tp=1&sp=10
  const spl = params.get("spl");
  const tp  = params.get("tp");
  const sp  = params.get("sp");
  addLine(lines, "SplPer", spl);
  addLine(lines, "TempPer", tp);
  addLine(lines, "SendPer", sp);

  return lines.join("\n");
}

/** ===== Web NFC (NDEFReader) ===== **/
function ensureWebNfc(){
  if (!("NDEFReader" in window)) {
    throw new Error("Web NFC indisponible : NDEFReader absent (pas le bon navigateur/contexte).");
  }
  if (!window.isSecureContext) {
    throw new Error("Contexte non sécurisé : il faut HTTPS.");
  }
}

async function writeNfcText(text){
  ensureWebNfc();
  const ndef = new NDEFReader();
  await ndef.write({ records: [{ recordType: "text", data: text, lang: "en" }] });
}

async function readNfcOnce(timeoutMs=15000){
  ensureWebNfc();
  const ndef = new NDEFReader();
  const ac = new AbortController();
  const t = setTimeout(() => ac.abort(), timeoutMs);

  return new Promise(async (resolve, reject) => {
    try {
      ndef.onreadingerror = () => reject(new Error("Lecture NFC impossible (retape la sonde)."));
      ndef.onreading = (event) => {
        try {
          const records = event.message.records || [];
          // On cherche un record texte (Elsys stocke généralement la config en texte)
          for (const r of records) {
            if (r.recordType === "text") {
              const txt = new TextDecoder(r.encoding || "utf-8").decode(r.data);
              clearTimeout(t); ac.abort();
              resolve(txt);
              return;
            }
          }
          // Si pas de texte, on affiche un résumé
          clearTimeout(t); ac.abort();
          resolve("(Aucun record texte trouvé sur le tag NFC)");
        } catch (e) {
          clearTimeout(t); ac.abort();
          reject(e);
        }
      };

      await ndef.scan({ signal: ac.signal });
    } catch (e) {
      clearTimeout(t);
      reject(e);
    }
  });
}

/** ===== Compare ===== **/
function compareConfigs(expectedText, readText){
  const expected = cfgToMap(expectedText);
  const read = cfgToMap(readText);

  const missing = [];
  const diff = [];
  for (const [k, v] of expected.entries()) {
    if (!read.has(k)) missing.push(k);
    else if (read.get(k) !== v) diff.push({k, expected:v, got:read.get(k)});
  }

  // Les extra keys ne sont pas bloquantes (la sonde peut stocker d'autres params)
  const extras = [];
  for (const [k, v] of read.entries()) {
    if (!expected.has(k)) extras.push({k, v});
  }

  const ok = (missing.length === 0 && diff.length === 0);
  return { ok, missing, diff, extras };
}

/** ===== UI ===== **/
function refresh(){
  const diag = [];
  diag.push(`HTTPS (secureContext): ${window.isSecureContext}`);
  diag.push(`NDEFReader présent: ${"NDEFReader" in window}`);
  diag.push(`Top-level: ${window.top === window}`);
  diag.push(`UA: ${navigator.userAgent}`);
  $("diag").textContent = diag.join("\n");

  try {
    const expected = buildCfgFromHarmony();
    $("expected").textContent = expected;
    $("status").innerHTML = "<span class='muted'>Prêt. ÉCRIRE pour configurer, ou LIRE pour vérifier.</span>";
  } catch (e) {
    $("expected").textContent = "(erreur)";
    $("status").innerHTML = "<span class='ko'>Erreur: </span>" + esc(e.message || e);
  }
}

$("writeBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  try {
    const expected = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Approche la sonde… (écriture NFC)</span>";
    await writeNfcText(expected);
    $("status").innerHTML = "<span class='ok'>OK : config écrite.</span> Redémarre la sonde pour lancer le JOIN.";
  } catch (e) {
    $("status").innerHTML = "<span class='ko'>Erreur: </span>" + esc(e.message || e);
  }
});

$("readBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  $("compareOut").textContent = "";
  try {
    const expected = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Approche la sonde… (lecture NFC)</span>";
    const readText = await readNfcOnce();
    $("readOut").textContent = readText;

    const res = compareConfigs(expected, readText);
    if (res.ok) {
      $("compareOut").innerHTML = "<span class='ok'>✅ OK : les paramètres essentiels correspondent.</span>";
    } else {
      let html = "<span class='ko'>⚠️ NOK : différences détectées.</span><br>";
      if (res.missing.length) html += "<b>Clés manquantes :</b> " + res.missing.map(esc).join(", ") + "<br>";
      if (res.diff.length) {
        html += "<b>Valeurs différentes :</b><br><ul>";
        for (const d of res.diff) {
          html += `<li><code>${esc(d.k)}</code> attendu <code>${esc(d.expected)}</code> / lu <code>${esc(d.got)}</code></li>`;
        }
        html += "</ul>";
      }
      // Extras: infos en plus sur la sonde, non bloquant
      if (res.extras.length) {
        html += "<details><summary>Paramètres en plus sur la sonde (non bloquant)</summary><ul>";
        for (const x of res.extras) html += `<li><code>${esc(x.k)}</code>: ${esc(x.v)}</li>`;
        html += "</ul></details>";
      }
      $("compareOut").innerHTML = html;
    }

    $("status").innerHTML = "<span class='ok'>Lecture OK.</span>";
  } catch (e) {
    $("status").innerHTML = "<span class='ko'>Erreur: </span>" + esc(e.message || e);
  }
});

window.addEventListener("hashchange", refresh);
refresh();
</script>
</body>
</html>
