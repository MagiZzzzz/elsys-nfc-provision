<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:900px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:780px){ .row{grid-template-columns:1fr} }
    button{font-size:18px;padding:14px;border-radius:12px;border:0;cursor:pointer;width:100%}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#f2f2f2}
    button.good{background:#0a7a20 !important;color:#fff}
    button.bad{background:#b00020 !important;color:#fff}
    button:disabled{opacity:.7;cursor:not-allowed}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px}
    .muted{opacity:.75}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    code{background:#f2f2f2;padding:2px 6px;border-radius:8px}
    .big{font-size:20px}
    a.btnlink{display:block;text-decoration:none;text-align:center;padding:14px;border-radius:12px;background:#111;color:#fff;font-size:18px}
    details summary{cursor:pointer}
  </style>
</head>

<body>
  <h2>Elsys NFC (Harmony ID)</h2>
  <div class="muted">
    Lien attendu : <code>?h=8001</code> ou <code>#h=8001</code> (le QR peut rester ultra court)
  </div>

  <!-- GATE: si Web NFC pas dispo -->
  <div class="card" id="gate" style="display:none;">
    <div class="big"><b>⚠️ Ce navigateur ne supporte pas la config NFC.</b></div>
    <div class="muted" style="margin-top:6px">
      Ouvre cette page dans <b>Google Chrome</b> sur Android, puis réessaie.
    </div>
    <div class="row" style="margin-top:12px;">
      <a id="openChromeLink" class="btnlink" href="#">Ouvrir dans Chrome</a>
      <button id="copyLinkBtn" class="secondary">Copier le lien</button>
    </div>
    <div class="muted" style="margin-top:10px" id="gateHint"></div>
  </div>

  <!-- MAIN -->
  <div class="card" id="main">
    <b>Config attendue (écrite en NFC)</b>
    <pre id="expected">(lecture...)</pre>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="writeBtn">ÉCRIRE DANS LA SONDE (NFC)</button>
      <button class="secondary" id="readBtn">LIRE LA SONDE (NFC)</button>
    </div>

    <p id="status" class="muted" style="margin:10px 0 0;"></p>
  </div>

  <div class="card">
    <b>Contenu NFC lu</b>
    <pre id="readOut">(rien lu pour l’instant)</pre>
    <div id="compareOut" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <b>Diagnostic</b>
    <pre id="diag" class="muted"></pre>
  </div>

<script>
/** =================================================================
 *  À ADAPTER (HEX)
 *  - AppEui doit faire 16 hex au total
 *  - AppKey doit faire 32 hex au total
 *  On complète avec l'ID Harmony.
 * ================================================================= **/
const APP_EUI_PREFIX = "EF1C1AEF1C1A";
const APP_KEY_PREFIX = "EF1C1AEF1C1AEF1C1AEF1C1AFFFF";

/** =================================================================
 *  PARAMÈTRES FIXES (toujours écrits, d'après ton joinlocal settings)
 * ================================================================= **/
const FIXED_SETTINGS = {
  // Timebase / périodes (SplPer = 600s)
  SplPer: 600,      // 600 seconds
  TempPer: 1,       // 1
  LightPer: 1,      // 1
  Co2Per: 2,        // 2
  PirPer: 0,        // 0
  VddPer: 12,       // 12
  SendPer: 1,       // 1

  // LoRaWAN
  Ota: 1,           // OTAA ON
  Ack: 0,           // Confirmed OFF
  Port: 5,          // <-- adapte si besoin

  // Extended / radio
  DrDef: 5,         // DR5
  DrMin: 3,         // DR3
  DrMax: 7,         // DR7

  // PIR OFF
  PirCfg: 0,        // PIR OFF

  // Link threshold/period : 4 bytes hex => threshold=1, period=6
  Link: "00010006",

  // Listen before talk OFF (si le firmware supporte la clé en NFC texte)
  LBT: 0
};

/** ===== Helpers ===== **/
const $ = (id) => document.getElementById(id);
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function isHex(s){ return /^[0-9A-F]+$/i.test(s); }
function padLeftHex(hex, len){
  hex = (hex||"").toUpperCase().replace(/[^0-9A-F]/g,"");
  return hex.padStart(len,"0");
}
function addLine(lines,k,v){
  if (v===null || v===undefined) return;
  const s = String(v).trim();
  if (!s) return;
  lines.push(`${k}:${s}`);
}
function normalizeCfg(text){
  return (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean).join("\n");
}
function cfgToMap(text){
  const m = new Map();
  for (const line of normalizeCfg(text).split("\n")) {
    const idx = line.indexOf(":");
    if (idx < 0) continue;
    const k = line.slice(0, idx).trim();
    const v = line.slice(idx+1).trim();
    if (k) m.set(k, v);
  }
  return m;
}

/** ===== Params: accepte ?h=... OU #h=... ===== **/
function getParams() {
  const hash = (location.hash || "").replace(/^#/, "").trim();
  const search = (location.search || "").replace(/^\?/, "").trim();
  const src = hash ? hash : search;
  return new URLSearchParams(decodeURIComponent(src));
}

/** ===== Build expected config from h=... ===== **/
function buildCfgFromHarmony() {
  const params = getParams();
  const hid = (params.get("h") || "").toUpperCase().replace(/[^0-9A-F]/g,"");
  if (!hid) throw new Error("ID Harmony manquant. Exemple: ?h=8001");

  // LoRaWAN sizes: AppEui=16 hex, AppKey=32 hex
  const needEui = 16 - APP_EUI_PREFIX.length;
  const needKey = 32 - APP_KEY_PREFIX.length;
  if (needEui <= 0) throw new Error("APP_EUI_PREFIX trop long (doit être < 16 hex).");
  if (needKey <= 0) throw new Error("APP_KEY_PREFIX trop long (doit être < 32 hex).");

  const idEui = padLeftHex(hid, needEui).slice(-needEui);
  const idKey = padLeftHex(hid, needKey).slice(-needKey);

  const appEui = (APP_EUI_PREFIX + idEui).toUpperCase();
  const appKey = (APP_KEY_PREFIX + idKey).toUpperCase();

  if (appEui.length !== 16 || !isHex(appEui)) throw new Error("AppEui généré invalide.");
  if (appKey.length !== 32 || !isHex(appKey)) throw new Error("AppKey généré invalide.");

  const lines = [];

  // Keys OTAA
  addLine(lines, "AppEui", appEui);
  addLine(lines, "AppKey", appKey);

  // Toujours écrire les settings fixes
  addLine(lines, "Ota", FIXED_SETTINGS.Ota);
  addLine(lines, "Ack", FIXED_SETTINGS.Ack);
  addLine(lines, "Port", FIXED_SETTINGS.Port);

  addLine(lines, "SplPer", FIXED_SETTINGS.SplPer);
  addLine(lines, "TempPer", FIXED_SETTINGS.TempPer);
  addLine(lines, "LightPer", FIXED_SETTINGS.LightPer);
  addLine(lines, "Co2Per", FIXED_SETTINGS.Co2Per);
  addLine(lines, "PirPer", FIXED_SETTINGS.PirPer);
  addLine(lines, "VddPer", FIXED_SETTINGS.VddPer);
  addLine(lines, "SendPer", FIXED_SETTINGS.SendPer);

  addLine(lines, "DrDef", FIXED_SETTINGS.DrDef);
  addLine(lines, "DrMin", FIXED_SETTINGS.DrMin);
  addLine(lines, "DrMax", FIXED_SETTINGS.DrMax);

  addLine(lines, "PirCfg", FIXED_SETTINGS.PirCfg);
  addLine(lines, "Link", FIXED_SETTINGS.Link);
  addLine(lines, "LBT", FIXED_SETTINGS.LBT);

  return lines.join("\n");
}

/** ===== Web NFC ===== **/
function webNfcAvailable() {
  return window.isSecureContext && ("NDEFReader" in window);
}
function ensureWebNfc(){
  if (!window.isSecureContext) throw new Error("HTTPS requis.");
  if (!("NDEFReader" in window)) throw new Error("Web NFC indisponible dans ce navigateur.");
}

async function writeNfcText(text){
  ensureWebNfc();
  const ndef = new NDEFReader();
  await ndef.write({ records: [{ recordType: "text", data: text, lang: "en" }] });
}

async function readNfcOnce(timeoutMs=60000){
  ensureWebNfc();
  const ndef = new NDEFReader();
  const ac = new AbortController();
  const t = setTimeout(() => ac.abort("timeout"), timeoutMs);

  return new Promise(async (resolve, reject) => {
    ndef.onreadingerror = () => reject(new Error("Lecture NFC impossible (retape la sonde en restant immobile 2–3s)."));

    ndef.onreading = (event) => {
      try {
        const out = [];
        for (const r of (event.message.records || [])) {
          const dataBuf = (r.data && r.data.buffer) ? r.data.buffer : r.data;
          if (r.recordType === "text") {
            out.push(new TextDecoder(r.encoding || "utf-8").decode(dataBuf));
          } else {
            // fallback: tente texte
            try { out.push(new TextDecoder("utf-8").decode(dataBuf)); }
            catch { out.push(`[${r.recordType}]`); }
          }
        }
        clearTimeout(t);
        ac.abort("done");
        resolve(out.join("\n").trim() || "(Tag lu, mais aucun texte lisible)");
      } catch (e) {
        clearTimeout(t);
        ac.abort("err");
        reject(e);
      }
    };

    try {
      await ndef.scan({ signal: ac.signal });
    } catch (e) {
      clearTimeout(t);
      reject(e);
    }
  });
}

/** ===== Compare read vs expected ===== **/
function compareConfigs(expectedText, readText){
  const expected = cfgToMap(expectedText);
  const read = cfgToMap(readText);

  const missing = [];
  const diff = [];
  for (const [k, v] of expected.entries()) {
    if (!read.has(k)) missing.push(k);
    else if (read.get(k) !== String(v)) diff.push({k, expected:String(v), got:read.get(k)});
  }

  const extras = [];
  for (const [k, v] of read.entries()) {
    if (!expected.has(k)) extras.push({k, v});
  }

  return { ok: missing.length === 0 && diff.length === 0, missing, diff, extras };
}

/** ===== Open in Chrome (sans rallonger le QR) ===== **/
function canonicalUrlForChrome() {
  // On force query (?...) car intent:// gère mieux la query que le hash
  const params = getParams().toString();
  const base = location.origin + location.pathname;
  return params ? (base + "?" + params) : base;
}
function makeIntentUrlChrome(httpsUrl) {
  const u = new URL(httpsUrl);
  const hostPathQuery = u.host + u.pathname + (u.search || "");
  return `intent://${hostPathQuery}#Intent;scheme=https;package=com.android.chrome;end`;
}

/** ===== UI ===== **/
function setWriteBtnState(state) {
  const b = $("writeBtn");
  b.classList.remove("good","bad");
  if (state === "ok") b.classList.add("good");
  if (state === "err") b.classList.add("bad");
}
function resetWriteBtn(){
  const b = $("writeBtn");
  b.disabled = false;
  b.textContent = "ÉCRIRE DANS LA SONDE (NFC)";
  b.classList.remove("good","bad");
}
function refresh() {
  const diag = [];
  diag.push(`HTTPS: ${window.isSecureContext}`);
  diag.push(`NDEFReader présent: ${"NDEFReader" in window}`);
  diag.push(`UA: ${navigator.userAgent}`);
  $("diag").textContent = diag.join("\n");

  // expected config
  try {
    $("expected").textContent = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Prêt. ÉCRIRE ou LIRE.</span>";
  } catch (e) {
    $("expected").textContent = "(erreur)";
    $("status").innerHTML = "<span class='ko'>Erreur:</span> " + esc(e.message || e);
  }

  // gate
  if (!webNfcAvailable()) {
    $("gate").style.display = "";
    $("main").style.display = "none";
    const canon = canonicalUrlForChrome();
    $("openChromeLink").href = makeIntentUrlChrome(canon);
    $("gateHint").innerHTML =
      "Clique <b>Ouvrir dans Chrome</b> (1 clic). Sinon, copie le lien et colle-le dans Chrome.";
  } else {
    $("gate").style.display = "none";
    $("main").style.display = "";
  }
}
$("copyLinkBtn").addEventListener("click", async () => {
  const url = canonicalUrlForChrome();
  try {
    await navigator.clipboard.writeText(url);
    $("gateHint").innerHTML = "<span class='ok'>✅ Lien copié.</span> Ouvre Chrome et colle-le.";
  } catch {
    $("gateHint").innerHTML = "<span class='ko'>Copie impossible automatiquement.</span> URL :<br><code>" + esc(url) + "</code>";
  }
});

/** ===== Actions ===== **/
$("writeBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  $("compareOut").textContent = "";
  setWriteBtnState(null);

  try {
    const cfg = buildCfgFromHarmony();

    // UI writing state
    const btn = $("writeBtn");
    btn.disabled = true;
    btn.textContent = "ÉCRITURE… (approche la sonde)";

    $("status").innerHTML = "<span class='muted'>Approche la sonde (zone NFC souvent près de la caméra) et reste immobile 2–3s…</span>";
    await writeNfcText(cfg);

    setWriteBtnState("ok");
    btn.textContent = "✅ ÉCRIT DANS LA SONDE";
    $("status").innerHTML = "<span class='ok'>OK : la config a bien été écrite.</span> Redémarre la sonde pour lancer le JOIN.";

    // On réactive le bouton après quelques secondes (si tu veux réécrire)
    setTimeout(() => {
      btn.disabled = false;
      // On garde le vert + le texte (comme tu veux)
    }, 2500);

  } catch (e) {
    setWriteBtnState("err");
    $("status").innerHTML = "<span class='ko'>Erreur :</span> " + esc(e.message || e);
    // reset bouton
    const btn = $("writeBtn");
    btn.disabled = false;
    btn.textContent = "ÉCRIRE DANS LA SONDE (NFC)";
  }
});

$("readBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  $("compareOut").textContent = "";
  $("readOut").textContent = "(lecture en cours...)";

  try {
    const expected = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Lecture NFC : approche la sonde et reste immobile 2–3s…</span>";

    const txt = await readNfcOnce(60000);
    $("readOut").textContent = normalizeCfg(txt) || "(vide)";

    const res = compareConfigs(expected, txt);
    if (res.ok) {
      $("compareOut").innerHTML = "<span class='ok'>✅ OK : les paramètres attendus correspondent.</span>";
    } else {
      let html = "<span class='ko'>⚠️ NOK : différences détectées.</span><br>";
      if (res.missing.length) html += "<b>Clés manquantes :</b> " + res.missing.map(esc).join(", ") + "<br>";
      if (res.diff.length) {
        html += "<b>Valeurs différentes :</b><ul>";
        for (const d of res.diff) {
          html += `<li><code>${esc(d.k)}</code> attendu <code>${esc(d.expected)}</code> / lu <code>${esc(d.got)}</code></li>`;
        }
        html += "</ul>";
      }
      if (res.extras.length) {
        html += "<details><summary>Paramètres en plus sur la sonde (non bloquant)</summary><ul>";
        for (const x of res.extras) html += `<li><code>${esc(x.k)}</code>: ${esc(x.v)}</li>`;
        html += "</ul></details>";
      }
      $("compareOut").innerHTML = html;
    }

    $("status").innerHTML = "<span class='ok'>Lecture OK.</span>";
  } catch (e) {
    $("readOut").textContent = "(rien lu)";
    $("status").innerHTML = "<span class='ko'>Erreur lecture :</span> " + esc(e.message || e);
  }
});

/** ===== Init ===== **/
window.addEventListener("hashchange", () => { resetWriteBtn(); refresh(); });
window.addEventListener("popstate", () => { resetWriteBtn(); refresh(); });
refresh();
</script>
</body>
</html>
