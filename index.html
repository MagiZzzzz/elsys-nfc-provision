<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <meta name="theme-color" content="#111111">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:22px;max-width:980px}
    .muted{opacity:.75}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 1px 10px rgba(0,0,0,.04)}
    h1{font-size:22px;margin:0 0 6px}
    h2{margin:0 0 10px;font-size:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    button{font-size:16px;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;width:100%}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#f2f2f2}
    button:disabled{opacity:.5;cursor:not-allowed}
    pre, textarea, input, select{
      width:100%; box-sizing:border-box;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      border:1px solid #ddd; border-radius:12px; padding:10px; background:#fafafa;
    }
    input, select { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#fff; }
    textarea{min-height:140px}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #ddd;cursor:pointer;background:#fff}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:900px){ .grid3{grid-template-columns:1fr} }
    .small{font-size:13px}
    .key{font-family:ui-monospace,monospace}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  </style>
</head>

<body>
  <h1>Elsys NFC Provision (Web NFC)</h1>
  <div class="muted">
    Fonctionne sans app uniquement sur <b>Android + Chrome</b> (HTTPS obligatoire). Web NFC = Ã©criture NDEF.  
  </div>

  <div class="card small">
    ðŸ”’ Les donnÃ©es aprÃ¨s <b>#</b> dans lâ€™URL ne sont pas envoyÃ©es au serveur (fragment).  
    Tu peux donc mettre <span class="key">AppKey</span>/<span class="key">AppEui</span> dans le QR sans backend.
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" id="tabScan">Mode Scan (QR â†’ Ã‰crire)</div>
      <div class="tab" id="tabBuild">Mode Formulaire (comme Sensor Settings)</div>
      <div class="tab" id="tabRaw">Mode Brut (Key:Value)</div>
    </div>
  </div>

  <!-- MODE SCAN -->
  <div class="card" id="paneScan">
    <h2>Mode Scan</h2>
    <div class="muted small">La config est lue depuis lâ€™URL (fragment #...).</div>
    <h3 style="margin:10px 0 8px;font-size:15px;">Config Ã  Ã©crire</h3>
    <pre id="cfgPreview">(aucune config dans lâ€™URL)</pre>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="writeBtn">Ã‰CRIRE DANS LA SONDE (NFC)</button>
      <button class="secondary" id="readBtn">LIRE LA SONDE (NFC)</button>
    </div>
    <p id="status" class="small" style="margin:10px 0 0;"></p>

    <div id="readTableWrap" style="display:none;margin-top:10px;">
      <h3 style="margin:10px 0 8px;font-size:15px;">Contenu lu (dÃ©composÃ©)</h3>
      <table id="readTable">
        <thead><tr><th>Key</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MODE BUILDER -->
  <div class="card" id="paneBuild" style="display:none;">
    <h2>Mode Formulaire</h2>
    <div class="muted small">
      Ce mode gÃ©nÃ¨re les lignes <span class="key">Key:Value</span> supportÃ©es par les docs Elsys (NFC spec + settings parameter).
    </div>

    <div class="card" style="background:#fcfcfc;border-color:#eee;">
      <h3 style="margin:0 0 10px;font-size:15px;">RÃ©seau</h3>
      <div class="row">
        <div>
          <label>Mode activation</label>
          <select id="f_mode">
            <option value="OTAA">OTAA</option>
            <option value="ABP">ABP</option>
          </select>
        </div>
        <div>
          <label>Ack (Confirmed uplinks)</label>
          <select id="f_ack">
            <option value="">(ne pas Ã©crire)</option>
            <option value="0">0 (Off)</option>
            <option value="1">1 (On)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>JoinEUI / AppEui (OTAA)</label>
          <input id="f_appeui" placeholder="1122334455667788 (16 hex)" />
        </div>
        <div>
          <label>AppKey (OTAA)</label>
          <input id="f_appkey" placeholder="001122... (32 hex)" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>DevAddr (ABP)</label>
          <input id="f_devaddr" placeholder="FE000000 (8 hex)" />
        </div>
        <div>
          <label>AppSKey (ABP)</label>
          <input id="f_appskey" placeholder="32 hex" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>NwkSKey (ABP)</label>
          <input id="f_nwkskey" placeholder="32 hex" />
        </div>
        <div>
          <label>Port</label>
          <input id="f_port" type="number" min="1" max="254" placeholder="5" />
        </div>
      </div>
    </div>

    <div class="card" style="background:#fcfcfc;border-color:#eee;">
      <h3 style="margin:0 0 10px;font-size:15px;">Radio</h3>
      <div class="row">
        <div>
          <label>Plan</label>
          <input id="f_plan" type="number" placeholder="(ex: EU868 selon capteur)" />
        </div>
        <div>
          <label>Subband</label>
          <input id="f_subband" type="number" placeholder="0..7 (hybrid)" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>DrDef</label>
          <input id="f_drdef" placeholder="DR0..DR?" />
        </div>
        <div>
          <label>DrMin</label>
          <input id="f_drmin" placeholder="DR0..DR?" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>DrMax</label>
          <input id="f_drmax" placeholder="DR0..DR?" />
        </div>
        <div class="muted small" style="align-self:end;">
          Astuce : si DrMin=DrDef=DrMax, le rÃ©seau ne pourra pas changer le DR.
        </div>
      </div>
    </div>

    <div class="card" style="background:#fcfcfc;border-color:#eee;">
      <h3 style="margin:0 0 10px;font-size:15px;">PÃ©riodes (base = SplPer)</h3>
      <div class="row">
        <div>
          <label>SplPer (secondes)</label>
          <input id="f_splper" type="number" min="1" placeholder="60" />
        </div>
        <div>
          <label>SendPer (multiplicateur)</label>
          <input id="f_sendper" type="number" min="1" placeholder="10 (=> 10Ã—SplPer)" />
        </div>
      </div>
      <div class="grid3" style="margin-top:10px;">
        <div><label>TempPer</label><input id="f_tempper" type="number" min="1" placeholder="1" /></div>
        <div><label>LightPer</label><input id="f_lightper" type="number" min="0" placeholder="" /></div>
        <div><label>PirPer</label><input id="f_pirper" type="number" min="0" placeholder="" /></div>
      </div>
      <div class="grid3" style="margin-top:10px;">
        <div><label>AccPer</label><input id="f_accper" type="number" min="0" placeholder="" /></div>
        <div><label>VddPer</label><input id="f_vddper" type="number" min="0" placeholder="" /></div>
        <div><label>Co2Per</label><input id="f_co2per" type="number" min="0" placeholder="" /></div>
      </div>
      <div class="grid3" style="margin-top:10px;">
        <div><label>ExtPer</label><input id="f_extper" type="number" min="0" placeholder="" /></div>
        <div><label>SoundPer</label><input id="f_soundper" type="number" min="0" placeholder="" /></div>
        <div><label>RhPer (legacy)</label><input id="f_rhper" type="number" min="0" placeholder="" /></div>
      </div>
    </div>

    <div class="card" style="background:#fcfcfc;border-color:#eee;">
      <h3 style="margin:0 0 10px;font-size:15px;">PIR / CO2 / Externe</h3>
      <div class="grid3">
        <div>
          <label>PirCfg</label>
          <input id="f_pircfg" type="number" placeholder="0..6 selon modÃ¨le" />
        </div>
        <div>
          <label>PirSens</label>
          <input id="f_pirsens" type="number" placeholder="0..2" />
        </div>
        <div>
          <label>Co2Cfg</label>
          <input id="f_co2cfg" type="number" placeholder="1 = calibrer (air frais)" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>ExtCfg</label>
          <input id="f_extcfg" type="number" placeholder="0..25 (selon doc)" />
        </div>
        <div>
          <label>ExtPwrTime (ms)</label>
          <input id="f_extpwr" type="number" min="0" placeholder="" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>TriggTime (ms)</label>
          <input id="f_triggtime" type="number" min="0" placeholder="" />
        </div>
        <div class="muted small" style="align-self:end;">
          Les options PIR/Ext dÃ©pendent du modÃ¨le (ERS/ELT/EMSâ€¦).
        </div>
      </div>
    </div>

    <div class="card" style="background:#fcfcfc;border-color:#eee;">
      <h3 style="margin:0 0 10px;font-size:15px;">Queue / SÃ©curitÃ© / AvancÃ©</h3>
      <div class="grid3">
        <div><label>Qsize (0..10)</label><input id="f_qsize" type="number" min="0" max="10" placeholder="" /></div>
        <div><label>Qoffset (0/1)</label><input id="f_qoffset" type="number" min="0" max="1" placeholder="" /></div>
        <div><label>Qpurge (0/1)</label><input id="f_qpurge" type="number" min="0" max="1" placeholder="" /></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Lock (0 = unlocked)</label>
          <input id="f_lock" type="number" placeholder="1234" />
        </div>
        <div>
          <label>AccCfg (hex 4 bytes)</label>
          <input id="f_acccfg" placeholder="00000000" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Link (hex 4 bytes)</label>
          <input id="f_link" placeholder="00000000" />
        </div>
        <div>
          <label>PerOvr (hex 4 bytes)</label>
          <input id="f_perovr" placeholder="00000000" />
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="buildToUrlBtn">GÃ‰NÃ‰RER LA CONFIG â†’ METTRE DANS Lâ€™URL (#...)</button>
      <button class="secondary" id="copyUrlBtn">COPIER Lâ€™URL (pour faire le QR)</button>
    </div>

    <pre id="buildOut" style="margin-top:10px;"></pre>
  </div>

  <!-- MODE RAW -->
  <div class="card" id="paneRaw" style="display:none;">
    <h2>Mode Brut</h2>
    <div class="muted small">Colle directement des lignes <span class="key">Key:Value</span> (toutes les clÃ©s supportÃ©es par Elsys fonctionneront).</div>
    <textarea id="rawEditor" spellcheck="false" placeholder="Ota:1&#10;Ack:0&#10;AppEui:1122334455667788&#10;AppKey:001122..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="rawToUrlBtn">METTRE DANS Lâ€™URL (#...)</button>
      <button class="secondary" id="rawCopyUrlBtn">COPIER Lâ€™URL</button>
    </div>
    <pre id="rawOut" style="margin-top:10px;"></pre>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const cfgPreview = $("cfgPreview");

  function esc(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function setStatus(html) { statusEl.innerHTML = html; }

  function parseCfgFromHash() {
    const h = (location.hash || "").replace(/^#/, "");
    if (!h) return "";
    const decoded = decodeURIComponent(h);
    return (decoded.includes("|") ? decoded.split("|").join("\n") : decoded).trim();
  }
  function normalizeCfg(text) {
    return text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).join("\n");
  }
  function cfgToHash(cfgText) {
    const lines = normalizeCfg(cfgText).split("\n");
    return encodeURIComponent(lines.join("|"));
  }
  function currentLinkWithHash(hashValue) {
    const base = location.origin + location.pathname;
    return base + "#" + hashValue;
  }

  function refreshPreview() {
    const cfg = parseCfgFromHash();
    cfgPreview.textContent = cfg || "(aucune config dans lâ€™URL)";
  }

  // Tabs
  function setTab(which) {
    const tabs = {Scan:["tabScan","paneScan"], Build:["tabBuild","paneBuild"], Raw:["tabRaw","paneRaw"]};
    for (const k of Object.keys(tabs)) {
      const [t,p] = tabs[k];
      $(t).classList.toggle("active", k===which);
      $(p).style.display = (k===which) ? "" : "none";
    }
  }
  $("tabScan").onclick = () => setTab("Scan");
  $("tabBuild").onclick = () => setTab("Build");
  $("tabRaw").onclick = () => setTab("Raw");

  // Web NFC
  const hasWebNfc = ("NDEFWriter" in window) && ("NDEFReader" in window);
  function requireWebNfcOrExplain() {
    if (!hasWebNfc) {
      setStatus('<span class="ko">Web NFC non supportÃ©.</span> Utilise Android + Chrome et un site en HTTPS.');
      return false;
    }
    return true;
  }
  async function writeCfgToNfc(cfg) {
    const writer = new NDEFWriter();
    await writer.write({ records: [{ recordType: "text", data: cfg, lang: "en" }] });
  }
  async function readOnceFromNfc(timeoutMs=15000) {
    const reader = new NDEFReader();
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), timeoutMs);

    return new Promise(async (resolve, reject) => {
      try {
        reader.onreadingerror = () => reject(new Error("Lecture NFC impossible (essaie de re-taper la sonde)."));
        reader.onreading = (event) => {
          try {
            const recs = event.message.records || [];
            for (const r of recs) {
              if (r.recordType === "text") {
                const txt = new TextDecoder(r.encoding || "utf-8").decode(r.data);
                clearTimeout(t); ac.abort(); resolve(txt); return;
              }
            }
            clearTimeout(t); ac.abort();
            resolve("(Pas de record texte trouvÃ©)");
          } catch (e) {
            clearTimeout(t); ac.abort(); reject(e);
          }
        };
        await reader.scan({ signal: ac.signal });
      } catch (e) {
        clearTimeout(t); reject(e);
      }
    });
  }

  // Scan pane buttons
  $("writeBtn").onclick = async () => {
    setStatus("");
    if (!requireWebNfcOrExplain()) return;
    const cfg = parseCfgFromHash();
    if (!cfg) { setStatus('<span class="ko">Aucune config dans lâ€™URL.</span>'); return; }
    try {
      setStatus("Approche la sondeâ€¦ (Ã©criture NFC)");
      await writeCfgToNfc(cfg);
      setStatus('<span class="ok">OK : config Ã©crite.</span> Le capteur peut redÃ©marrer aprÃ¨s changement (â‰ˆ 5s).');
    } catch (e) {
      setStatus('<span class="ko">Erreur Ã©criture NFC :</span> ' + esc(e.message || String(e)));
    }
  };

  function fillReadTable(text) {
    const wrap = $("readTableWrap");
    const tbody = $("readTable").querySelector("tbody");
    tbody.innerHTML = "";
    const lines = normalizeCfg(text).split("\n").filter(Boolean);
    for (const line of lines) {
      const idx = line.indexOf(":");
      const k = idx>=0 ? line.slice(0, idx).trim() : line.trim();
      const v = idx>=0 ? line.slice(idx+1).trim() : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="key">${esc(k)}</td><td>${esc(v)}</td>`;
      tbody.appendChild(tr);
    }
    wrap.style.display = "";
  }

  $("readBtn").onclick = async () => {
    setStatus("");
    if (!requireWebNfcOrExplain()) return;
    try {
      setStatus("Approche la sondeâ€¦ (lecture NFC)");
      const txt = await readOnceFromNfc();
      setStatus('<span class="ok">Lecture OK.</span>');
      cfgPreview.textContent = txt;
      fillReadTable(txt);
    } catch (e) {
      setStatus('<span class="ko">Erreur lecture NFC :</span> ' + esc(e.message || String(e)));
    }
  };

  // Builder -> config lines
  function addLine(lines, key, val) {
    if (val === null || val === undefined) return;
    const s = String(val).trim();
    if (!s) return;
    lines.push(`${key}:${s}`);
  }

  function buildConfigFromForm() {
    const lines = [];
    const mode = $("f_mode").value;

    // Mode
    addLine(lines, "Ota", mode === "OTAA" ? "1" : "0");
    addLine(lines, "Ack", $("f_ack").value);

    if (mode === "OTAA") {
      addLine(lines, "AppEui", $("f_appeui").value);
      addLine(lines, "AppKey", $("f_appkey").value);
    } else {
      addLine(lines, "DevAddr", $("f_devaddr").value);
      addLine(lines, "AppSKey", $("f_appskey").value);
      addLine(lines, "NwkSKey", $("f_nwkskey").value);
    }

    addLine(lines, "Port", $("f_port").value);

    // Radio
    addLine(lines, "Plan", $("f_plan").value);
    addLine(lines, "Subband", $("f_subband").value);
    addLine(lines, "DrDef", $("f_drdef").value);
    addLine(lines, "DrMin", $("f_drmin").value);
    addLine(lines, "DrMax", $("f_drmax").value);

    // Periods
    addLine(lines, "SplPer", $("f_splper").value);
    addLine(lines, "SendPer", $("f_sendper").value);
    addLine(lines, "TempPer", $("f_tempper").value);
    addLine(lines, "LightPer", $("f_lightper").value);
    addLine(lines, "PirPer", $("f_pirper").value);
    addLine(lines, "AccPer", $("f_accper").value);
    addLine(lines, "VddPer", $("f_vddper").value);
    addLine(lines, "Co2Per", $("f_co2per").value);
    addLine(lines, "ExtPer", $("f_extper").value);
    addLine(lines, "SoundPer", $("f_soundper").value);
    addLine(lines, "RhPer", $("f_rhper").value);

    // PIR/Ext/CO2
    addLine(lines, "PirCfg", $("f_pircfg").value);
    addLine(lines, "PirSens", $("f_pirsens").value);
    addLine(lines, "Co2Cfg", $("f_co2cfg").value);
    addLine(lines, "ExtCfg", $("f_extcfg").value);
    addLine(lines, "ExtPwrTime", $("f_extpwr").value);
    addLine(lines, "TriggTime", $("f_triggtime").value);

    // Queue / security / advanced
    addLine(lines, "Qsize", $("f_qsize").value);
    addLine(lines, "Qoffset", $("f_qoffset").value);
    addLine(lines, "Qpurge", $("f_qpurge").value);
    addLine(lines, "Lock", $("f_lock").value);
    addLine(lines, "AccCfg", $("f_acccfg").value);
    addLine(lines, "Link", $("f_link").value);
    addLine(lines, "PerOvr", $("f_perovr").value);

    return lines.join("\n");
  }

  $("buildToUrlBtn").onclick = () => {
    const cfg = buildConfigFromForm();
    $("buildOut").textContent = cfg || "(vide)";
    const url = currentLinkWithHash(cfgToHash(cfg));
    location.hash = cfgToHash(cfg);
    refreshPreview();
    setStatus('<span class="ok">Config gÃ©nÃ©rÃ©e.</span> Tu peux maintenant retourner en â€œMode Scanâ€ et Ã©crire en NFC.');
  };

  $("copyUrlBtn").onclick = async () => {
    const cfg = buildConfigFromForm();
    $("buildOut").textContent = cfg || "(vide)";
    const url = currentLinkWithHash(cfgToHash(cfg));
    try { await navigator.clipboard.writeText(url); }
    catch {}
    $("buildOut").textContent = url;
    setStatus('<span class="ok">URL prÃªte pour QR.</span>');
  };

  // Raw mode
  $("rawToUrlBtn").onclick = () => {
    const cfg = normalizeCfg($("rawEditor").value);
    const url = currentLinkWithHash(cfgToHash(cfg));
    location.hash = cfgToHash(cfg);
    $("rawOut").textContent = url;
    refreshPreview();
    setStatus('<span class="ok">OK.</span>');
  };
  $("rawCopyUrlBtn").onclick = async () => {
    const cfg = normalizeCfg($("rawEditor").value);
    const url = currentLinkWithHash(cfgToHash(cfg));
    try { await navigator.clipboard.writeText(url); } catch {}
    $("rawOut").textContent = url;
    setStatus('<span class="ok">URL copiÃ©e.</span>');
  };

  // Init
  refreshPreview();
  if (!hasWebNfc) {
    $("writeBtn").disabled = true;
    $("readBtn").disabled = true;
    setStatus('<span class="ko">Web NFC non supportÃ©.</span> Android + Chrome uniquement.');
  }

  // Service worker (offline after first open)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }
</script>
</body>
</html>
