<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <meta name="theme-color" content="#111111">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:22px;max-width:980px}
    .muted{opacity:.75}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 1px 10px rgba(0,0,0,.04)}
    h1{font-size:22px;margin:0 0 6px}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:12px 0 8px;font-size:15px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    button{font-size:16px;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;width:100%}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#f2f2f2}
    button:disabled{opacity:.5;cursor:not-allowed}
    pre, textarea, input, select{
      width:100%; box-sizing:border-box;
      border:1px solid #ddd; border-radius:12px; padding:10px;
    }
    pre, textarea{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#fafafa;
      white-space:pre-wrap;
      word-break:break-word;
    }
    input, select { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#fff; }
    textarea{min-height:140px}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #ddd;cursor:pointer;background:#fff}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .small{font-size:13px}
    code{background:#f2f2f2;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <h1>Elsys NFC Provision (Web NFC)</h1>
  <div class="muted">
    Sans appli : fonctionne uniquement sur <b>Android + Chrome</b> (HTTPS).<br>
    QR court recommand√© : <code>#h=&lt;id_harmony&gt;</code>
  </div>

  <div class="card small">
    üí° Astuce : tout ce qui est apr√®s <b>#</b> dans l‚ÄôURL n‚Äôest pas envoy√© au serveur.  
    Exemple : <code>#h=1A2B</code>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" id="tabScan">Mode Scan (QR ‚Üí √âcrire)</div>
      <div class="tab" id="tabHarmony">Mode Harmony ID (QR ultra court)</div>
      <div class="tab" id="tabRaw">Mode Brut (Key:Value)</div>
    </div>
  </div>

  <!-- MODE SCAN -->
  <div class="card" id="paneScan">
    <h2>Mode Scan</h2>
    <div class="muted small">
      La config est calcul√©e depuis l‚ÄôURL (fragment <code>#...</code>), soit via <code>#h=</code>, soit via le format long.
    </div>

    <h3>Config √† √©crire (calcul√©e)</h3>
    <pre id="cfgPreview">(aucune config dans l‚ÄôURL)</pre>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="writeBtn">√âCRIRE DANS LA SONDE (NFC)</button>
      <button class="secondary" id="readBtn">LIRE LA SONDE (NFC)</button>
    </div>
    <p id="status" class="small" style="margin:10px 0 0;"></p>
  </div>

  <!-- MODE HARMONY -->
  <div class="card" id="paneHarmony" style="display:none;">
    <h2>Mode Harmony ID (QR ultra court)</h2>
    <div class="muted small">
      Tu mets seulement l‚ÄôID Harmony dans le QR : <code>#h=1A2B</code><br>
      La page calcule automatiquement :
      <ul>
        <li><code>AppEui = APP_EUI_PREFIX + &lt;id_harmony&gt;</code> (padd√© pour faire 16 hex)</li>
        <li><code>AppKey = APP_KEY_PREFIX + &lt;id_harmony&gt;</code> (padd√© pour faire 32 hex)</li>
      </ul>
      ‚ö†Ô∏è Tes pr√©fixes doivent √™tre plus courts que 16 (AppEui) et 32 (AppKey) en hex.
    </div>

    <div class="row">
      <div>
        <label><b>ID Harmony</b> (hex, ex: 1A2B, 000F, 12ABCD)</label>
        <input id="h_id" placeholder="1A2B" />
        <div class="muted small">Conseil : reste sur un ID court en hex, √ßa garde le QR petit.</div>
      </div>
      <div>
        <label><b>Options (facultatif)</b></label>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:8px">
          <div><input id="h_spl" type="number" placeholder="spl (SplPer) = 60" /></div>
          <div><input id="h_tp" type="number" placeholder="tp (TempPer) = 1" /></div>
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><input id="h_sp" type="number" placeholder="sp (SendPer) = 10" /></div>
          <div><input id="h_p"  type="number" placeholder="p (Port) = 5" /></div>
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div>
            <select id="h_a">
              <option value="">a (Ack) = 0 (d√©faut)</option>
              <option value="0">a=0 (unconfirmed)</option>
              <option value="1">a=1 (confirmed)</option>
            </select>
          </div>
          <div>
            <select id="h_o">
              <option value="">o (Ota) = 1 (d√©faut)</option>
              <option value="1">o=1 (OTAA)</option>
              <option value="0">o=0 (ABP) ‚ö†Ô∏è</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="h_makeUrlBtn">G√âN√âRER URL COURTE (pour QR)</button>
      <button class="secondary" id="h_copyUrlBtn">COPIER L‚ÄôURL</button>
    </div>

    <h3>URL √† mettre dans le QR</h3>
    <pre id="h_urlOut"></pre>

    <h3>Config g√©n√©r√©e (ce qui sera √©crit en NFC)</h3>
    <pre id="h_cfgOut"></pre>
  </div>

  <!-- MODE RAW -->
  <div class="card" id="paneRaw" style="display:none;">
    <h2>Mode Brut (Key:Value)</h2>
    <div class="muted small">
      Colle des lignes <code>Key:Value</code> (une par ligne), puis g√©n√®re l‚ÄôURL longue (moins adapt√© au 9mm).
    </div>
    <textarea id="rawEditor" spellcheck="false" placeholder="Ota:1&#10;Ack:0&#10;AppEui:1122334455667788&#10;AppKey:001122...&#10;SplPer:60&#10;TempPer:1&#10;SendPer:10&#10;Port:5"></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="rawToUrlBtn">METTRE DANS L‚ÄôURL (#...)</button>
      <button class="secondary" id="rawCopyUrlBtn">COPIER L‚ÄôURL</button>
    </div>

    <h3>URL g√©n√©r√©e</h3>
    <pre id="rawOut"></pre>
  </div>

<script>
  /******************************************************************
   * ‚ö†Ô∏è √Ä ADAPTER ICI : tes pr√©fixes (HEX)
   ******************************************************************/
  const APP_EUI_PREFIX = "EF1C1AEF1C1A";             // ex: "EF1C1AEF1C1A"
  const APP_KEY_PREFIX = "EF1C1AEF1C1AEF1C1AEF1C1AFFFF"; // ex: "EF1C1AEF1C1AEF1C1AEF1C1AFFFF"

  /******************************************************************
   * Helpers
   ******************************************************************/
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const cfgPreview = $("cfgPreview");

  function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function setStatus(html) { statusEl.innerHTML = html; }

  function normalizeCfg(text) {
    return (text || "")
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(Boolean)
      .join("\n");
  }

  function cfgToHash(cfgText) {
    const lines = normalizeCfg(cfgText).split("\n");
    return encodeURIComponent(lines.join("|"));
  }

  function currentLinkWithHash(hashValue) {
    const base = location.origin + location.pathname;
    return base + "#" + hashValue;
  }

  function isHex(s) {
    return /^[0-9A-F]+$/i.test(s);
  }

  function padLeftHex(hex, len) {
    hex = (hex || "").toUpperCase().replace(/[^0-9A-F]/g, "");
    return hex.padStart(len, "0");
  }

  function addLine(lines, k, v) {
    if (v === null || v === undefined) return;
    const s = String(v).trim();
    if (!s) return;
    lines.push(`${k}:${s}`);
  }

  /******************************************************************
   * G√©n√©ration AppEui/AppKey √† partir de l‚ÄôID Harmony
   ******************************************************************/
  function buildCfgFromHarmonyId(harmonyId, params) {
    const lines = [];

    const needEui = 16 - APP_EUI_PREFIX.length; // AppEui = 16 hex
    const needKey = 32 - APP_KEY_PREFIX.length; // AppKey = 32 hex

    if (needEui <= 0) throw new Error("APP_EUI_PREFIX trop long (doit √™tre < 16 hex).");
    if (needKey <= 0) throw new Error("APP_KEY_PREFIX trop long (doit √™tre < 32 hex).");

    // On remplit exactement la longueur manquante
    const idEui = padLeftHex(harmonyId, needEui).slice(-needEui);
    const idKey = padLeftHex(harmonyId, needKey).slice(-needKey);

    const appEui = (APP_EUI_PREFIX + idEui).toUpperCase();
    const appKey = (APP_KEY_PREFIX + idKey).toUpperCase();

    if (appEui.length !== 16 || !isHex(appEui)) throw new Error("AppEui g√©n√©r√© invalide.");
    if (appKey.length !== 32 || !isHex(appKey)) throw new Error("AppKey g√©n√©r√© invalide.");

    // Defaults (ultra simples)
    const ota = params.get("o") ?? "1";
    const ack = params.get("a") ?? "0";
    const port = params.get("p") ?? "5";
    const spl  = params.get("spl") ?? "60";
    const tp   = params.get("tp") ?? "1";
    const sp   = params.get("sp") ?? "10";

    addLine(lines, "Ota", ota);
    addLine(lines, "Ack", ack);
    addLine(lines, "AppEui", appEui);
    addLine(lines, "AppKey", appKey);
    addLine(lines, "Port", port);

    // Periods (tu peux enlever si tu veux encore plus minimal)
    addLine(lines, "SplPer", spl);
    addLine(lines, "TempPer", tp);
    addLine(lines, "SendPer", sp);

    return lines.join("\n");
  }

  /******************************************************************
   * Parse URL hash
   ******************************************************************/
  function parseCfgFromHash() {
    const raw = decodeURIComponent((location.hash || "").replace(/^#/, "")).trim();
    if (!raw) return "";

    // Format court: #h=1A2B&spl=60&tp=1&sp=10&p=5&a=0&o=1
    if (raw.startsWith("h=") || raw.includes("&h=")) {
      const params = new URLSearchParams(raw);
      const hid = (params.get("h") || "").toUpperCase().replace(/[^0-9A-F]/g, "");
      if (!hid) throw new Error("ID Harmony manquant (#h=...).");
      return buildCfgFromHarmonyId(hid, params);
    }

    // Ancien format long: #Key:Value|Key:Value|...
    return (raw.includes("|") ? raw.split("|").join("\n") : raw);
  }

  function refreshPreview() {
    try {
      const cfg = parseCfgFromHash();
      cfgPreview.textContent = cfg || "(aucune config dans l‚ÄôURL)";
    } catch (e) {
      cfgPreview.textContent = "(erreur de config)";
      setStatus('<span class="ko">Erreur :</span> ' + esc(e.message || String(e)));
    }
  }

  /******************************************************************
   * Tabs
   ******************************************************************/
  function setTab(which) {
    const tabs = {
      Scan:["tabScan","paneScan"],
      Harmony:["tabHarmony","paneHarmony"],
      Raw:["tabRaw","paneRaw"]
    };
    for (const k of Object.keys(tabs)) {
      const [t,p] = tabs[k];
      $(t).classList.toggle("active", k===which);
      $(p).style.display = (k===which) ? "" : "none";
    }
  }
  $("tabScan").onclick = () => setTab("Scan");
  $("tabHarmony").onclick = () => setTab("Harmony");
  $("tabRaw").onclick = () => setTab("Raw");

  /******************************************************************
   * Web NFC
   ******************************************************************/
  const hasWebNfc = ("NDEFWriter" in window) && ("NDEFReader" in window);

  function requireWebNfcOrExplain() {
    if (!hasWebNfc) {
      setStatus('<span class="ko">Web NFC non support√©.</span> Utilise Android + Chrome (HTTPS).');
      return false;
    }
    return true;
  }

  async function writeCfgToNfc(cfg) {
    const writer = new NDEFWriter();
    await writer.write({ records: [{ recordType: "text", data: cfg, lang: "en" }] });
  }

  async function readOnceFromNfc(timeoutMs=15000) {
    const reader = new NDEFReader();
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), timeoutMs);

    return new Promise(async (resolve, reject) => {
      try {
        reader.onreadingerror = () => reject(new Error("Lecture NFC impossible (re-tape la sonde)."));
        reader.onreading = (event) => {
          try {
            const recs = event.message.records || [];
            for (const r of recs) {
              if (r.recordType === "text") {
                const txt = new TextDecoder(r.encoding || "utf-8").decode(r.data);
                clearTimeout(t); ac.abort(); resolve(txt); return;
              }
            }
            clearTimeout(t); ac.abort();
            resolve("(Pas de record texte trouv√©)");
          } catch (e) {
            clearTimeout(t); ac.abort(); reject(e);
          }
        };
        await reader.scan({ signal: ac.signal });
      } catch (e) {
        clearTimeout(t); reject(e);
      }
    });
  }

  $("writeBtn").onclick = async () => {
    setStatus("");
    if (!requireWebNfcOrExplain()) return;

    let cfg = "";
    try { cfg = parseCfgFromHash(); } catch (e) {
      setStatus('<span class="ko">Erreur config :</span> ' + esc(e.message || String(e)));
      return;
    }

    if (!cfg) {
      setStatus('<span class="ko">Aucune config dans l‚ÄôURL.</span> Utilise le mode Harmony (#h=...) ou colle une config brute.');
      return;
    }

    try {
      setStatus("Approche la sonde‚Ä¶ (√©criture NFC)");
      await writeCfgToNfc(cfg);
      setStatus('<span class="ok">OK : config √©crite.</span> Red√©marre la sonde pour d√©clencher le JOIN.');
    } catch (e) {
      setStatus('<span class="ko">Erreur √©criture NFC :</span> ' + esc(e.message || String(e)));
    }
  };

  $("readBtn").onclick = async () => {
    setStatus("");
    if (!requireWebNfcOrExplain()) return;

    try {
      setStatus("Approche la sonde‚Ä¶ (lecture NFC)");
      const txt = await readOnceFromNfc();
      setStatus('<span class="ok">Lecture OK.</span> Contenu affich√© ci-dessus.');
      cfgPreview.textContent = txt;
    } catch (e) {
      setStatus('<span class="ko">Erreur lecture NFC :</span> ' + esc(e.message || String(e)));
    }
  };

  /******************************************************************
   * Harmony URL generator
   ******************************************************************/
  function makeHarmonyUrl(copyToHash=false) {
    const hid = ($("h_id").value || "").toUpperCase().replace(/[^0-9A-F]/g, "");
    if (!hid) throw new Error("ID Harmony vide.");

    const params = new URLSearchParams();
    params.set("h", hid);

    // Ajoute seulement si renseign√© (garde le QR court)
    const spl = $("h_spl").value.trim();
    const tp  = $("h_tp").value.trim();
    const sp  = $("h_sp").value.trim();
    const p   = $("h_p").value.trim();
    const a   = $("h_a").value.trim();
    const o   = $("h_o").value.trim();

    if (spl) params.set("spl", spl);
    if (tp)  params.set("tp", tp);
    if (sp)  params.set("sp", sp);
    if (p)   params.set("p", p);
    if (a)   params.set("a", a);
    if (o)   params.set("o", o);

    const hash = params.toString(); // ex: h=1A2B&spl=60...
    const url = currentLinkWithHash(hash);

    // Build config preview from the same params
    const cfg = buildCfgFromHarmonyId(hid, params);

    if (copyToHash) location.hash = hash;

    return { url, cfg, hash };
  }

  $("h_makeUrlBtn").onclick = () => {
    setStatus("");
    try {
      const { url, cfg, hash } = makeHarmonyUrl(true);
      $("h_urlOut").textContent = url;
      $("h_cfgOut").textContent = cfg;
      refreshPreview();
      setStatus('<span class="ok">OK.</span> URL pr√™te ‚Üí mets-la dans le QR (P-Touch).');
    } catch (e) {
      setStatus('<span class="ko">Erreur :</span> ' + esc(e.message || String(e)));
    }
  };

  $("h_copyUrlBtn").onclick = async () => {
    setStatus("");
    try {
      const { url, cfg } = makeHarmonyUrl(false);
      $("h_urlOut").textContent = url;
      $("h_cfgOut").textContent = cfg;

      try { await navigator.clipboard.writeText(url); } catch {}
      setStatus('<span class="ok">URL copi√©e.</span>');
    } catch (e) {
      setStatus('<span class="ko">Erreur :</span> ' + esc(e.message || String(e)));
    }
  };

  /******************************************************************
   * Raw URL generator
   ******************************************************************/
  $("rawToUrlBtn").onclick = () => {
    setStatus("");
    const cfg = normalizeCfg($("rawEditor").value);
    if (!cfg) { setStatus('<span class="ko">Config vide.</span>'); return; }

    const url = currentLinkWithHash(cfgToHash(cfg));
    $("rawOut").textContent = url;
    location.hash = cfgToHash(cfg);
    refreshPreview();
    setStatus('<span class="ok">OK.</span> URL g√©n√©r√©e.');
  };

  $("rawCopyUrlBtn").onclick = async () => {
    setStatus("");
    const cfg = normalizeCfg($("rawEditor").value);
    if (!cfg) { setStatus('<span class="ko">Config vide.</span>'); return; }

    const url = currentLinkWithHash(cfgToHash(cfg));
    $("rawOut").textContent = url;
    try { await navigator.clipboard.writeText(url); } catch {}
    setStatus('<span class="ok">URL copi√©e.</span>');
  };

  /******************************************************************
   * Service Worker (offline apr√®s 1√®re ouverture)
   ******************************************************************/
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // Init
  refreshPreview();
  if (!hasWebNfc) {
    $("writeBtn").disabled = true;
    $("readBtn").disabled = true;
    setStatus('<span class="ko">Web NFC non support√©.</span> Android + Chrome uniquement.');
  }

  window.addEventListener("hashchange", refreshPreview);
</script>
</body>
</html>
