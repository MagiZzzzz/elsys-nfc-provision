<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:820px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    button{font-size:18px;padding:14px;border-radius:12px;border:0;cursor:pointer;width:100%}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#f2f2f2}
    button.good{background:#0a7a20 !important;color:#fff}
    button.bad{background:#b00020 !important;color:#fff}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px}
    .muted{opacity:.75}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    code{background:#f2f2f2;padding:2px 6px;border-radius:8px}
    .big{font-size:20px}
    a.btnlink{display:block;text-decoration:none;text-align:center;padding:14px;border-radius:12px;background:#111;color:#fff;font-size:18px}
  </style>
</head>

<body>
  <h2>Elsys NFC (Harmony ID)</h2>
  <div class="muted">
    URL attendue : <code>?h=8001</code> ou <code>#h=8001</code>
    (optionnel : <code>&p=5&a=0</code>)
  </div>

  <!-- GATE: affiché si Web NFC pas dispo -->
  <div class="card" id="gate" style="display:none;">
    <div class="big"><b>⚠️ Ce navigateur ne supporte pas la config NFC.</b></div>
    <div class="muted" style="margin-top:6px">
      Ouvre cette page dans <b>Google Chrome</b> sur Android, puis réessaie.
    </div>
    <div class="row" style="margin-top:12px;">
      <a id="openChromeLink" class="btnlink" href="#">Ouvrir dans Chrome</a>
      <button id="copyLinkBtn" class="secondary">Copier le lien</button>
    </div>
    <div class="muted" style="margin-top:10px" id="gateHint"></div>
  </div>

  <!-- MAIN -->
  <div class="card" id="main">
    <b>Config attendue (écrite en NFC)</b>
    <pre id="expected">(lecture...)</pre>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="writeBtn">ÉCRIRE DANS LA SONDE (NFC)</button>
      <button class="secondary" id="readBtn">LIRE LA SONDE (NFC)</button>
    </div>

    <p id="status" class="muted" style="margin:10px 0 0;"></p>
  </div>

  <div class="card">
    <b>Contenu NFC lu</b>
    <pre id="readOut">(rien lu pour l’instant)</pre>
  </div>

  <div class="card">
    <b>Diagnostic</b>
    <pre id="diag" class="muted"></pre>
  </div>

<script>
/** ===== À ADAPTER (HEX) ===== **/
const APP_EUI_PREFIX = "EF1C1AEF1C1A";
const APP_KEY_PREFIX = "EF1C1AEF1C1AEF1C1AEF1C1AFFFF";

/** ===== Helpers ===== **/
const $ = (id) => document.getElementById(id);
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function isHex(s){ return /^[0-9A-F]+$/i.test(s); }
function padLeftHex(hex, len){
  hex = (hex||"").toUpperCase().replace(/[^0-9A-F]/g,"");
  return hex.padStart(len,"0");
}
function addLine(lines,k,v){
  if (v===null || v===undefined) return;
  const s = String(v).trim();
  if (!s) return;
  lines.push(`${k}:${s}`);
}
function normalizeCfg(text){
  return (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean).join("\n");
}

/** ===== Params: accepte ?h=... OU #h=... ===== **/
function getParams() {
  const hash = (location.hash || "").replace(/^#/, "").trim();
  const search = (location.search || "").replace(/^\?/, "").trim();
  const src = hash ? hash : search;
  return new URLSearchParams(decodeURIComponent(src));
}

/** ===== Build expected config from h=... ===== **/
function buildCfgFromHarmony() {
  const params = getParams();
  const hid = (params.get("h") || "").toUpperCase().replace(/[^0-9A-F]/g,"");
  if (!hid) throw new Error("ID Harmony manquant. Exemple: ?h=8001");

  // LoRaWAN sizes: AppEui=16 hex, AppKey=32 hex
  const needEui = 16 - APP_EUI_PREFIX.length;
  const needKey = 32 - APP_KEY_PREFIX.length;
  if (needEui <= 0) throw new Error("APP_EUI_PREFIX trop long (doit être < 16 hex).");
  if (needKey <= 0) throw new Error("APP_KEY_PREFIX trop long (doit être < 32 hex).");

  const idEui = padLeftHex(hid, needEui).slice(-needEui);
  const idKey = padLeftHex(hid, needKey).slice(-needKey);

  const appEui = (APP_EUI_PREFIX + idEui).toUpperCase();
  const appKey = (APP_KEY_PREFIX + idKey).toUpperCase();

  if (appEui.length !== 16 || !isHex(appEui)) throw new Error("AppEui généré invalide.");
  if (appKey.length !== 32 || !isHex(appKey)) throw new Error("AppKey généré invalide.");

  const ota  = params.get("o") ?? "1";
  const ack  = params.get("a") ?? "0";
  const port = params.get("p") ?? "5";

  const lines = [];
  addLine(lines, "Ota", ota);
  addLine(lines, "Ack", ack);
  addLine(lines, "AppEui", appEui);
  addLine(lines, "AppKey", appKey);
  addLine(lines, "Port", port);

  // Optionnels si tu veux les mettre parfois: &spl=60&tp=1&sp=10
  addLine(lines, "SplPer", params.get("spl"));
  addLine(lines, "TempPer", params.get("tp"));
  addLine(lines, "SendPer", params.get("sp"));

  return lines.join("\n");
}

/** ===== Web NFC ===== **/
function webNfcAvailable() {
  return window.isSecureContext && ("NDEFReader" in window);
}
function ensureWebNfc(){
  if (!window.isSecureContext) throw new Error("HTTPS requis.");
  if (!("NDEFReader" in window)) throw new Error("Web NFC indisponible dans ce navigateur.");
}

async function writeNfcText(text){
  ensureWebNfc();
  // API moderne: NDEFReader.write()
  const ndef = new NDEFReader();
  await ndef.write({ records: [{ recordType: "text", data: text, lang: "en" }] });
}

async function readNfcOnce(timeoutMs=60000){
  ensureWebNfc();
  const ndef = new NDEFReader();
  const ac = new AbortController();
  const t = setTimeout(() => ac.abort("timeout"), timeoutMs);

  const p = new Promise(async (resolve, reject) => {
    ndef.onreadingerror = () => reject(new Error("Lecture NFC impossible (retape la sonde en restant immobile 2–3s)."));
    ndef.onreading = (event) => {
      try {
        const out = [];
        for (const r of (event.message.records || [])) {
          const dataBuf = (r.data && r.data.buffer) ? r.data.buffer : r.data;
          if (r.recordType === "text") {
            out.push(new TextDecoder(r.encoding || "utf-8").decode(dataBuf));
          } else {
            // fallback: tente texte
            try { out.push(new TextDecoder("utf-8").decode(dataBuf)); }
            catch { out.push(`[${r.recordType}]`); }
          }
        }
        clearTimeout(t);
        ac.abort("done");
        resolve(out.join("\n").trim() || "(Tag lu, mais aucun texte lisible)");
      } catch (e) {
        clearTimeout(t);
        ac.abort("err");
        reject(e);
      }
    };

    try {
      await ndef.scan({ signal: ac.signal });
    } catch (e) {
      clearTimeout(t);
      reject(e);
    }
  });

  return p;
}

/** ===== “Open in Chrome” without long QR ===== **/
function canonicalUrlForChrome() {
  // Si params sont en hash (#...), on les bascule en query (?...) pour l’intent
  const params = getParams().toString();
  const base = location.origin + location.pathname;
  return params ? (base + "?" + params) : base;
}
function makeIntentUrlChrome(httpsUrl) {
  // https://host/path?query  -> intent://host/path?query#Intent;scheme=https;package=com.android.chrome;end
  const u = new URL(httpsUrl);
  const hostPathQuery = u.host + u.pathname + (u.search || "");
  return `intent://${hostPathQuery}#Intent;scheme=https;package=com.android.chrome;end`;
}

/** ===== UI ===== **/
function setWriteBtnState(state) {
  const b = $("writeBtn");
  b.classList.remove("good","bad");
  if (state === "ok") b.classList.add("good");
  if (state === "err") b.classList.add("bad");
}

function refresh() {
  const diag = [];
  diag.push(`HTTPS: ${window.isSecureContext}`);
  diag.push(`NDEFReader présent: ${"NDEFReader" in window}`);
  diag.push(`UA: ${navigator.userAgent}`);
  $("diag").textContent = diag.join("\n");

  // Expected config
  try {
    $("expected").textContent = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Prêt. ÉCRIRE ou LIRE.</span>";
  } catch (e) {
    $("expected").textContent = "(erreur)";
    $("status").innerHTML = "<span class='ko'>Erreur:</span> " + esc(e.message || e);
  }

  // Gate for wrong browser
  if (!webNfcAvailable()) {
    $("gate").style.display = "";
    $("main").style.display = "none";

    const canon = canonicalUrlForChrome();
    $("openChromeLink").href = makeIntentUrlChrome(canon);
    $("gateHint").innerHTML =
      "Lien court OK sur étiquette. Si ça s’ouvre dans le mauvais navigateur, clique ici → <b>Ouvrir dans Chrome</b>.<br>" +
      "Sinon, copie le lien et colle-le dans Chrome.";
  } else {
    $("gate").style.display = "none";
    $("main").style.display = "";
  }
}

$("copyLinkBtn").addEventListener("click", async () => {
  const url = canonicalUrlForChrome();
  try {
    await navigator.clipboard.writeText(url);
    $("gateHint").innerHTML = "<span class='ok'>✅ Lien copié.</span> Ouvre Chrome et colle-le dans la barre d’adresse.";
  } catch {
    $("gateHint").innerHTML = "<span class='ko'>Impossible de copier automatiquement.</span> Copie manuellement l’URL :<br><code>" + esc(url) + "</code>";
  }
});

$("writeBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  setWriteBtnState(null);

  try {
    const cfg = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Approche la sonde… (écriture NFC)</span>";
    await writeNfcText(cfg);

    setWriteBtnState("ok");
    $("writeBtn").textContent = "✅ ÉCRIT DANS LA SONDE";
    $("status").innerHTML = "<span class='ok'>OK : la config a bien été écrite.</span> Redémarre la sonde pour lancer le JOIN.";
  } catch (e) {
    setWriteBtnState("err");
    $("status").innerHTML = "<span class='ko'>Erreur :</span> " + esc(e.message || e);
  }
});

$("readBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  $("readOut").textContent = "(lecture en cours...)";

  try {
    $("status").innerHTML = "<span class='muted'>Lecture NFC : approche la sonde et reste immobile 2–3s…</span>";
    const txt = await readNfcOnce(60000);
    $("readOut").textContent = normalizeCfg(txt) || "(vide)";
    $("status").innerHTML = "<span class='ok'>Lecture OK.</span>";
  } catch (e) {
    $("readOut").textContent = "(rien lu)";
    $("status").innerHTML = "<span class='ko'>Erreur lecture :</span> " + esc(e.message || e);
  }
});

window.addEventListener("hashchange", refresh);
window.addEventListener("popstate", refresh);
refresh();
</script>
</body>
</html>
