<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elsys NFC Provision</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:720px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:12px 0}
    button{font-size:18px;padding:14px;border-radius:12px;border:0;cursor:pointer;width:100%;background:#111;color:#fff}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px}
    .muted{opacity:.75}
    .ok{color:#0a7a20;font-weight:700}
    .ko{color:#b00020;font-weight:700}
    code{background:#f2f2f2;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <h2>Elsys NFC (Harmony ID)</h2>
  <div class="muted">
    URL attendue : <code>#h=1A2B</code> (optionnel : <code>&p=5&a=0</code>)
  </div>

  <div class="card">
    <b>Configuration générée (écrite en NFC)</b>
    <pre id="cfg">(lecture...)</pre>
    <p id="status" class="muted"></p>
    <button id="writeBtn">ÉCRIRE DANS LA SONDE (NFC)</button>
  </div>

  <div class="card">
    <b>Diagnostic</b>
    <pre id="diag" class="muted"></pre>
  </div>

<script>
/** ===== À ADAPTER ===== **/
const APP_EUI_PREFIX = "EF1C1AEF1C1A";                  // hex
const APP_KEY_PREFIX = "EF1C1AEF1C1AEF1C1AEF1C1AFFFF";  // hex

const $ = (id) => document.getElementById(id);
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function isHex(s){ return /^[0-9A-F]+$/i.test(s); }
function padLeftHex(hex, len){
  hex = (hex||"").toUpperCase().replace(/[^0-9A-F]/g,"");
  return hex.padStart(len,"0");
}
function addLine(lines,k,v){
  if (v===null || v===undefined) return;
  const s = String(v).trim();
  if (!s) return;
  lines.push(`${k}:${s}`);
}
function getParamsFromHash(){
  const raw = decodeURIComponent((location.hash||"").replace(/^#/,"")).trim();
  return new URLSearchParams(raw);
}

function buildCfgFromHarmony() {
  const params = getParamsFromHash();
  const hid = (params.get("h") || "").toUpperCase().replace(/[^0-9A-F]/g,"");
  if (!hid) throw new Error("ID Harmony manquant. Exemple: #h=1A2B");

  // LoRaWAN: AppEui = 16 hex, AppKey = 32 hex
  const needEui = 16 - APP_EUI_PREFIX.length;
  const needKey = 32 - APP_KEY_PREFIX.length;
  if (needEui <= 0) throw new Error("APP_EUI_PREFIX trop long (doit être < 16 hex).");
  if (needKey <= 0) throw new Error("APP_KEY_PREFIX trop long (doit être < 32 hex).");

  const idEui = padLeftHex(hid, needEui).slice(-needEui);
  const idKey = padLeftHex(hid, needKey).slice(-needKey);

  const appEui = (APP_EUI_PREFIX + idEui).toUpperCase();
  const appKey = (APP_KEY_PREFIX + idKey).toUpperCase();

  if (appEui.length !== 16 || !isHex(appEui)) throw new Error("AppEui généré invalide.");
  if (appKey.length !== 32 || !isHex(appKey)) throw new Error("AppKey généré invalide.");

  // Defaults minimal join
  const ota  = params.get("o") ?? "1";
  const ack  = params.get("a") ?? "0";
  const port = params.get("p") ?? "5";

  const lines = [];
  addLine(lines, "Ota", ota);
  addLine(lines, "Ack", ack);
  addLine(lines, "AppEui", appEui);
  addLine(lines, "AppKey", appKey);
  addLine(lines, "Port", port);

  return lines.join("\n");
}

async function writeNfcText(text){
  // ✅ Web NFC moderne : NDEFReader (pas NDEFWriter)
  if (!("NDEFReader" in window)) {
    throw new Error("Web NFC indisponible : NDEFReader absent dans ce navigateur.");
  }
  if (!window.isSecureContext) {
    throw new Error("Contexte non sécurisé (il faut HTTPS).");
  }
  // Écriture (déclenche le prompt permission NFC si besoin) :contentReference[oaicite:2]{index=2}
  const ndef = new NDEFReader();
  await ndef.write({ records: [{ recordType: "text", data: text, lang: "en" }] });
}

function refresh() {
  const diag = [];
  diag.push(`HTTPS (secureContext): ${window.isSecureContext}`);
  diag.push(`NDEFReader présent: ${"NDEFReader" in window}`);
  diag.push(`Top-level: ${window.top === window}`);
  diag.push(`UA: ${navigator.userAgent}`);
  $("diag").textContent = diag.join("\n");

  try {
    const cfg = buildCfgFromHarmony();
    $("cfg").textContent = cfg;
    $("status").innerHTML = "<span class='muted'>Prêt. Clique sur ÉCRIRE puis colle le téléphone sur la sonde.</span>";
  } catch (e) {
    $("cfg").textContent = "(erreur)";
    $("status").innerHTML = "<span class='ko'>Erreur: </span>" + esc(e.message || e);
  }
}

$("writeBtn").addEventListener("click", async () => {
  $("status").textContent = "";
  try {
    const cfg = buildCfgFromHarmony();
    $("status").innerHTML = "<span class='muted'>Approche la sonde…</span>";
    await writeNfcText(cfg);
    $("status").innerHTML = "<span class='ok'>OK : écrit en NFC.</span> Redémarre la sonde pour lancer le JOIN.";
  } catch (e) {
    $("status").innerHTML = "<span class='ko'>Erreur: </span>" + esc(e.message || e);
  }
});

window.addEventListener("hashchange", refresh);
refresh();
</script>
</body>
</html>
